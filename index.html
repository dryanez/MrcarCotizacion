<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mr. Car - Cotiza tu Auto</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/css/intlTelInput.css">
    <style>
        .iti {
            width: 100%;
            display: block;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .wizard-container {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            padding: 50px;
            max-width: 650px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            min-height: 500px;
            position: relative;
        }

        .logo {
            text-align: center;
            margin-bottom: 20px;
        }

        .logo img {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 50%;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }

        h1 {
            color: #2d3748;
            font-size: 32px;
            margin-bottom: 8px;
            text-align: center;
        }

        .subtitle {
            color: #718096;
            font-size: 16px;
            text-align: center;
            margin-bottom: 40px;
        }

        .progress-bar {
            background: #e2e8f0;
            height: 6px;
            border-radius: 3px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            transition: width 0.3s ease;
        }

        .step {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .step.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .question {
            margin-bottom: 30px;
        }

        label {
            display: block;
            color: #2d3748;
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 18px;
        }

        input,
        select {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 16px 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
            margin-top: 12px;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .quotation {
            display: none;
        }

        .quotation.active {
            display: block;
        }

        .car-info {
            background: #f7fafc;
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 24px;
        }

        .car-info h3 {
            color: #667eea;
            margin-bottom: 16px;
            font-size: 20px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .info-item {
            padding: 12px;
            background: white;
            border-radius: 8px;
        }

        .info-label {
            font-size: 12px;
            color: #718096;
            margin-bottom: 4px;
        }

        .info-value {
            font-size: 16px;
            color: #2d3748;
            font-weight: 600;
        }

        .price-box {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 32px;
            border-radius: 16px;
            text-align: center;
            margin-bottom: 24px;
        }

        .price-label {
            font-size: 16px;
            margin-bottom: 8px;
            opacity: 0.9;
        }

        .price-value {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .price-range {
            font-size: 14px;
            opacity: 0.85;
        }

        .whatsapp-btn {
            background: #25D366;
            font-size: 20px;
            padding: 20px;
        }

        .whatsapp-btn:hover {
            background: #1fb854;
        }

        .error {
            background: #fed7d7;
            border: 2px solid #fc8181;
            color: #c53030;
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: none;
        }

        .error.active {
            display: block;
        }

        .helper-text {
            font-size: 14px;
            color: #718096;
            margin-top: 8px;
        }
    </style>
</head>

<body>
    <div class="wizard-container">
        <div class="logo"><img src="/static/mrcarlogo.png" alt="Mr. Car Logo"></div>
        <p class="subtitle">Cotiza tu veh√≠culo en minutos</p>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>

        <div class="error" id="errorMsg"></div>

        <!-- Step 1: Nombre y Apellido -->
        <div class="step active" data-step="1">
            <div class="question">
                <label>¬øCu√°l es tu nombre?</label>
                <div style="display: flex; gap: 12px; margin-bottom: 0;">
                    <div style="flex: 1;">
                        <input type="text" id="firstName" placeholder="Nombre" autofocus>
                    </div>
                    <div style="flex: 1;">
                        <input type="text" id="lastName" placeholder="Apellido">
                    </div>
                </div>
                <div class="helper-text" style="margin-top: 8px;">Ingresa tu nombre y apellido</div>
            </div>
            <button class="btn" onclick="nextStep()">Continuar</button>
        </div>

        <!-- Step 2: Tel√©fono -->
        <div class="step" data-step="2">
            <div class="question">
                <label for="phone">¬øCu√°l es tu n√∫mero de tel√©fono?</label>
                <input type="tel" id="phone" placeholder="+56 9 1234 5678">
                <div class="helper-text">Para contactarte sobre la cotizaci√≥n</div>
            </div>
            <button class="btn" onclick="nextStep()">Continuar</button>
            <button class="btn btn-secondary" onclick="prevStep()">Volver</button>
        </div>

        <!-- Step 3: Email -->
        <div class="step" data-step="3">
            <div class="question">
                <label for="email">¬øCu√°l es tu correo electr√≥nico?</label>
                <input type="email" id="email" placeholder="juan@example.com">
                <div class="helper-text">Te enviaremos la cotizaci√≥n por email</div>
            </div>
            <button class="btn" onclick="nextStep()">Continuar</button>
            <button class="btn btn-secondary" onclick="prevStep()">Volver</button>
        </div>

        <!-- Step 4: Regi√≥n y Comuna -->
        <div class="step" data-step="4">
            <div class="question">
                <label>¬øD√≥nde te encuentras?</label>
                <div style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label for="region" style="font-size: 14px; margin-bottom: 4px;">Regi√≥n</label>
                        <select id="region" onchange="updateCommunes()">
                            <option value="">Selecciona tu regi√≥n</option>
                            <option value="RM">Metropolitana de Santiago</option>
                            <option value="I">Tarapac√°</option>
                            <option value="II">Antofagasta</option>
                            <option value="III">Atacama</option>
                            <option value="IV">Coquimbo</option>
                            <option value="V">Valpara√≠so</option>
                            <option value="VI">O'Higgins</option>
                            <option value="VII">Maule</option>
                            <option value="VIII">Biob√≠o</option>
                            <option value="IX">Araucan√≠a</option>
                            <option value="X">Los Lagos</option>
                            <option value="XI">Ays√©n</option>
                            <option value="XII">Magallanes</option>
                            <option value="XIV">Los R√≠os</option>
                            <option value="XV">Arica y Parinacota</option>
                            <option value="XVI">√ëuble</option>
                        </select>
                    </div>
                    <div>
                        <label for="commune" style="font-size: 14px; margin-bottom: 4px;">Comuna</label>
                        <select id="commune" disabled>
                            <option value="">Selecciona una regi√≥n primero</option>
                        </select>
                    </div>
                </div>
            </div>
            <button class="btn" onclick="nextStep()">Continuar</button>
            <button class="btn btn-secondary" onclick="prevStep()">Volver</button>
        </div>

        <!-- Step 5: Patente -->
        <div class="step" data-step="5">
            <div class="question">
                <label for="plate">¬øCu√°l es la patente de tu veh√≠culo?</label>
                <input type="text" id="plate" placeholder="ABCD12" maxlength="8" style="text-transform: uppercase">
                <div class="helper-text">Ingresa la patente para obtener los datos del veh√≠culo</div>
            </div>
            <button class="btn" onclick="fetchCarInfo()">Buscar Veh√≠culo</button>
            <button class="btn btn-secondary" onclick="prevStep()">Volver</button>
        </div>

        <!-- Step 6: Detalles del Veh√≠culo (Version & KM) -->
        <div class="step" data-step="6">
            <div class="question">
                <label>Confirma los detalles</label>

                <div class="car-info" id="scrapedInfo" style="margin-bottom: 20px; padding: 16px;">
                    <div style="font-weight: bold; color: #667eea;" id="scrapedTitle">-</div>
                    <div style="font-size: 14px; color: #718096;" id="scrapedYear">-</div>
                </div>

                <div style="margin-bottom: 16px;">
                    <label for="version" style="font-size: 14px;">Versi√≥n (Opcional)</label>
                    <input type="text" id="version" placeholder="Ej: GLX 2.0 Automatico">
                    <div class="helper-text">Especifica la versi√≥n si la conoces</div>
                </div>

                <div>
                    <label for="mileage" style="font-size: 14px;">Kilometraje Actual</label>
                    <input type="number" id="mileage" placeholder="50000">
                </div>
            </div>
            <button class="btn" onclick="generateQuotation()">Obtener Cotizaci√≥n</button>
            <button class="btn btn-secondary" onclick="prevStep()">Volver</button>
        </div>

        <!-- Loading State -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Obteniendo la mejor cotizaci√≥n...</p>
        </div>

        <!-- Final Quotation -->
        <div class="quotation" id="quotation">
            <h2 style="text-align: center; margin-bottom: 24px; color: #2d3748;">Tu Cotizaci√≥n</h2>

            <div class="car-info">
                <h3>üìã Informaci√≥n del Veh√≠culo</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Marca</div>
                        <div class="info-value" id="q-make">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Modelo</div>
                        <div class="info-value" id="q-model">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">A√±o</div>
                        <div class="info-value" id="q-year">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Kilometraje</div>
                        <div class="info-value" id="q-mileage">-</div>
                    </div>
                </div>
            </div>

            <!-- Market Price -->
            <div class="price-box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="price-label">üíµ Valor de Mercado</div>
                <div class="price-value" id="marketPrice">$--</div>
                <div class="price-range" id="priceRange">Rango: $-- - $--</div>
            </div>

            <!-- Two columns for offers -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                <!-- Immediate Purchase Offer -->
                <div class="price-box" style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);">
                    <div class="price-label" style="font-size: 14px;">‚úÖ Compra Inmediata</div>
                    <div class="price-value" style="font-size: 28px;" id="immediateOffer">$--</div>
                    <div class="price-range" style="font-size: 11px;">Pago directo al momento</div>
                </div>

                <!-- Consignment Liquidation -->
                <div class="price-box" style="background: linear-gradient(135deg, #f6ad55 0%, #ed8936 100%);">
                    <div class="price-label" style="font-size: 14px;">ü§ù Consignaci√≥n</div>
                    <div class="price-value" style="font-size: 28px;" id="consignmentPrice">$--</div>
                    <div class="price-range" style="font-size: 11px;" id="consignmentFee">Liquidaci√≥n neta</div>
                </div>
            </div>

            <!-- Market Analysis -->
            <div id="marketAnalysis" class="car-info" style="display: none; margin-bottom: 24px;">
                <h3>üìä An√°lisis de Mercado</h3>
                <p id="analysisText" style="color: #4a5568; line-height: 1.6; margin-bottom: 12px;"></p>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 13px; color: #718096;">Confianza:</span>
                    <div style="flex: 1; background: #e2e8f0; border-radius: 8px; height: 8px; overflow: hidden;">
                        <div id="confidenceBar"
                            style="height: 100%; background: linear-gradient(135deg, #48bb78, #38a169); border-radius: 8px; transition: width 0.5s;">
                        </div>
                    </div>
                    <span id="confidenceText" style="font-size: 13px; font-weight: 600; color: #48bb78;"></span>
                </div>
            </div>

            <!-- Source Links -->
            <div id="sourcesSection" class="car-info" style="display: none; margin-bottom: 24px;">
                <h3>üîó Fuentes y Listados</h3>
                <div id="sourcesList" style="display: flex; flex-direction: column; gap: 8px;"></div>
            </div>

            <button class="btn whatsapp-btn" onclick="sellWithUs()">
                üì± Vende con Nosotros
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/intlTelInput.min.js"></script>
    <script>
        const API_BASE = '';
        let currentStep = 1;
        const totalSteps = 6;
        let formData = {};
        let carData = {};
        let phoneInput = null;

        const regionsCommunes = {
            "XV": ["Arica", "Camarones", "Putre", "General Lagos"],
            "I": ["Iquique", "Alto Hospicio", "Pozo Almonte", "Cami√±a", "Colchane", "Huara", "Pica"],
            "II": ["Antofagasta", "Mejillones", "Sierra Gorda", "Taltal", "Calama", "Ollag√ºe", "San Pedro de Atacama", "Tocopilla", "Mar√≠a Elena"],
            "III": ["Copiap√≥", "Caldera", "Tierra Amarilla", "Cha√±aral", "Diego de Almagro", "Vallenar", "Alto del Carmen", "Freirina", "Huasco"],
            "IV": ["La Serena", "Coquimbo", "Andacollo", "La Higuera", "Paiguano", "Vicu√±a", "Illapel", "Canela", "Los Vilos", "Salamanca", "Ovalle", "Combarbal√°", "Monte Patria", "Punitaqui", "R√≠o Hurtado"],
            "V": ["Valpara√≠so", "Casablanca", "Conc√≥n", "Juan Fern√°ndez", "Puchuncav√≠", "Quintero", "Vi√±a del Mar", "Isla de Pascua", "Los Andes", "Calle Larga", "Rinconada", "San Esteban", "La Ligua", "Cabildo", "Papudo", "Petorca", "Zapallar", "Quillota", "Calera", "Hijuelas", "La Cruz", "Nogales", "San Antonio", "Algarrobo", "Cartagena", "El Quisco", "El Tabo", "Santo Domingo", "San Felipe", "Catemu", "Llaillay", "Panquehue", "Putaendo", "Santa Mar√≠a", "Quilpu√©", "Limache", "Olmu√©", "Villa Alemana"],
            "RM": ["Santiago", "Cerrillos", "Cerro Navia", "Conchal√≠", "El Bosque", "Estaci√≥n Central", "Huechuraba", "Independencia", "La Cisterna", "La Florida", "La Granja", "La Pintana", "La Reina", "Las Condes", "Lo Barnechea", "Lo Espejo", "Lo Prado", "Macul", "Maip√∫", "√ëu√±oa", "Pedro Aguirre Cerda", "Pe√±alol√©n", "Providencia", "Pudahuel", "Quilicura", "Quinta Normal", "Recoleta", "Renca", "San Joaqu√≠n", "San Miguel", "San Ram√≥n", "Vitacura", "Puente Alto", "Pirque", "San Jos√© de Maipo", "Colina", "Lampa", "Til Til", "San Bernardo", "Buin", "Calera de Tango", "Paine", "Melipilla", "Alhu√©", "Curacav√≠", "Mar√≠a Pinto", "San Pedro", "Talagante", "El Monte", "Isla de Maipo", "Padre Hurtado", "Pe√±aflor"],
            "VI": ["Rancagua", "Codegua", "Coinco", "Coltauco", "Do√±ihue", "Graneros", "Las Cabras", "Machal√≠", "Malloa", "Mostazal", "Olivar", "Peumo", "Pichidegua", "Quinta de Tilcoco", "Rengo", "Requ√≠noa", "San Vicente", "Pichilemu", "La Estrella", "Litueche", "Marchihue", "Navidad", "Paredones", "San Fernando", "Ch√©pica", "Chimbarongo", "Lolol", "Nancagua", "Palmilla", "Peralillo", "Placilla", "Pumanque", "Santa Cruz"],
            "VII": ["Talca", "Constituci√≥n", "Curepto", "Empedrado", "Maule", "Pelarco", "Pencahue", "R√≠o Claro", "San Clemente", "San Rafael", "Cauquenes", "Chanco", "Pelluhue", "Curic√≥", "Huala√±√©", "Licant√©n", "Molina", "Rauco", "Romeral", "Sagrada Familia", "Teno", "Vichuqu√©n", "Linares", "Colb√∫n", "Longav√≠", "Parral", "Retiro", "San Javier", "Villa Alegre", "Yerbas Buenas"],
            "XVI": ["Chill√°n", "Bulnes", "Cobquecura", "Coelemu", "Coihueco", "Chill√°n Viejo", "El Carmen", "Ninhue", "√ëiqu√©n", "Pemuco", "Pinto", "Portezuelo", "Quill√≥n", "Quirihue", "R√°nquil", "San Carlos", "San Fabi√°n", "San Ignacio", "San Nicol√°s", "Treguaco", "Yungay"],
            "VIII": ["Concepci√≥n", "Coronel", "Chiguayante", "Florida", "Hualqui", "Lota", "Penco", "San Pedro de la Paz", "Santa Juana", "Talcahuano", "Tom√©", "Hualp√©n", "Lebu", "Arauco", "Ca√±ete", "Contulmo", "Curanilahue", "Los √Ålamos", "Tir√∫a", "Los √Ångeles", "Antuco", "Cabrero", "Laja", "Mulch√©n", "Nacimiento", "Negrete", "Quilaco", "Quilleco", "San Rosendo", "Santa B√°rbara", "Tucapel", "Yumbel", "Alto Biob√≠o"],
            "IX": ["Temuco", "Carahue", "Cunco", "Curarrehue", "Freire", "Galvarino", "Gorbea", "Lautaro", "Loncoche", "Melipeuco", "Nueva Imperial", "Padre Las Casas", "Perquenco", "Pitrufqu√©n", "Puc√≥n", "Saavedra", "Teodoro Schmidt", "Tolt√©n", "Vilc√∫n", "Villarrica", "Cholchol", "Angol", "Collipulli", "Curacaut√≠n", "Ercilla", "Lonquimay", "Los Sauces", "Lumaco", "Pur√©n", "Renaico", "Traigu√©n", "Victoria"],
            "XIV": ["Valdivia", "Corral", "Lanco", "Los Lagos", "M√°fil", "Mariquina", "Paillaco", "Panguipulli", "La Uni√≥n", "Futrono", "Lago Ranco", "R√≠o Bueno"],
            "X": ["Puerto Montt", "Calbuco", "Cocham√≥", "Fresia", "Frutillar", "Los Muermos", "Llanquihue", "Maull√≠n", "Puerto Varas", "Castro", "Ancud", "Chonchi", "Curaco de V√©lez", "Dalcahue", "Puqueld√≥n", "Queil√©n", "Quell√≥n", "Quemchi", "Quinchao", "Osorno", "Puerto Octay", "Purranque", "Puyehue", "R√≠o Negro", "San Juan de la Costa", "San Pablo", "Chait√©n", "Futaleuf√∫", "Hualaihu√©", "Palena"],
            "XI": ["Coyhaique", "Lago Verde", "Ays√©n", "Cisnes", "Guaitecas", "Cochrane", "O'Higgins", "Tortel", "Chile Chico", "R√≠o Ib√°√±ez"],
            "XII": ["Punta Arenas", "Laguna Blanca", "R√≠o Verde", "San Gregorio", "Cabo de Hornos (Ex Navarino)", "Ant√°rtica", "Porvenir", "Primavera", "Timaukel", "Natales", "Torres del Paine"]
        };

        function updateCommunes() {
            const regionSelect = document.getElementById("region");
            const communeSelect = document.getElementById("commune");
            const selectedRegion = regionSelect.value;

            // Clear current options
            communeSelect.innerHTML = '<option value="">Selecciona tu comuna</option>';

            if (selectedRegion && regionsCommunes[selectedRegion]) {
                const communes = regionsCommunes[selectedRegion].sort();
                communes.forEach(commune => {
                    const option = document.createElement("option");
                    option.value = commune;
                    option.textContent = commune;
                    communeSelect.appendChild(option);
                });
                communeSelect.disabled = false;
            } else {
                communeSelect.disabled = true;
                communeSelect.innerHTML = '<option value="">Selecciona una regi√≥n primero</option>';
            }
        }

        // Load saved data and initialize elements
        window.onload = () => {
            // Initialize Phone Input first
            const input = document.getElementById("phone");
            phoneInput = window.intlTelInput(input, {
                initialCountry: "cl",
                separateDialCode: true,
                preferredCountries: ["cl", "ar", "pe", "bo"],
                utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/utils.js",
            });

            const saved = localStorage.getItem('mrcar_quotation');
            if (saved) {
                formData = JSON.parse(saved);

                // Restore Form Fields
                if (formData.firstName) document.getElementById('firstName').value = formData.firstName;
                if (formData.lastName) document.getElementById('lastName').value = formData.lastName;
                if (formData.phone) phoneInput.setNumber(formData.phone);
                if (formData.email) document.getElementById('email').value = formData.email;
                if (formData.plate) document.getElementById('plate').value = formData.plate;
                if (formData.mileage) document.getElementById('mileage').value = formData.mileage;
                if (formData.version) document.getElementById('version').value = formData.version;

                // Restore Region and Commune
                if (formData.region) {
                    const regionSelect = document.getElementById('region');
                    regionSelect.value = formData.region;

                    // Trigger update to populate communes
                    updateCommunes();

                    if (formData.commune) {
                        document.getElementById('commune').value = formData.commune;
                    }
                }
            }
        };

        function updateProgress() {
            const progress = (currentStep / totalSteps) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function saveData() {
            localStorage.setItem('mrcar_quotation', JSON.stringify(formData));
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMsg');
            errorEl.textContent = message;
            errorEl.classList.add('active');
            setTimeout(() => errorEl.classList.remove('active'), 5000);
        }

        function nextStep() {
            // Validate current step
            let valid = true;
            let value = '';

            switch (currentStep) {
                case 1:
                    const fname = document.getElementById('firstName').value.trim();
                    const lname = document.getElementById('lastName').value.trim();
                    if (!fname || !lname) {
                        showError('Por favor ingresa tu nombre y apellido');
                        return;
                    }
                    formData.firstName = fname;
                    formData.lastName = lname;
                    break;
                case 2:
                    // Use intl-tel-input validation and formatting
                    if (!phoneInput.isValidNumber()) {
                        showError('Por favor ingresa un n√∫mero de tel√©fono v√°lido');
                        return;
                    }
                    formData.phone = phoneInput.getNumber(); // Get full international number E.164
                    break;
                case 3:
                    value = document.getElementById('email').value.trim();
                    if (!value || !value.includes('@')) {
                        showError('Por favor ingresa un email v√°lido');
                        return;
                    }
                    formData.email = value;
                    break;
                case 4:
                    const region = document.getElementById('region').value;
                    const commune = document.getElementById('commune').value.trim();
                    if (!region || !commune) {
                        showError('Por favor completa tu ubicaci√≥n');
                        return;
                    }
                    formData.region = region;
                    formData.commune = commune;
                    break;
            }

            saveData();

            // Hide current step
            document.querySelector(`.step[data-step="${currentStep}"]`).classList.remove('active');

            // Show next step
            currentStep++;
            document.querySelector(`.step[data-step="${currentStep}"]`).classList.add('active');
            updateProgress();

            // Focus first input
            const nextInput = document.querySelector(`.step[data-step="${currentStep}"] input`);
            if (nextInput) nextInput.focus();
        }

        function prevStep() {
            document.querySelector(`.step[data-step="${currentStep}"]`).classList.remove('active');
            currentStep--;
            document.querySelector(`.step[data-step="${currentStep}"]`).classList.add('active');
            updateProgress();
        }

        async function fetchCarInfo() {
            const plate = document.getElementById('plate').value.trim().toUpperCase();

            if (!plate) {
                showError('Por favor ingresa una patente');
                return;
            }

            formData.plate = plate;
            saveData();

            // Show loading
            document.querySelector(`.step[data-step="${currentStep}"]`).style.display = 'none';
            document.getElementById('loading').classList.add('active');

            try {
                const response = await fetch(`${API_BASE}/api/vehicle/${plate}`);
                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'Error al buscar el veh√≠culo');
                }

                carData = data;
                formData.carData = data;
                saveData();

                // Hide loading
                document.getElementById('loading').classList.remove('active');

                // Go to next step -> Step 6 (Details)
                currentStep++;
                document.querySelector(`.step[data-step="${currentStep}"]`).classList.add('active');

                // Prefill summary in Step 6
                document.getElementById('scrapedTitle').textContent = `${data.make} ${data.model}`;
                document.getElementById('scrapedYear').textContent = `A√±o: ${data.year}`;

                updateProgress();
                document.getElementById('mileage').focus();

            } catch (error) {
                document.getElementById('loading').classList.remove('active');
                document.querySelector(`.step[data-step="${currentStep}"]`).style.display = 'block';
                showError(error.message);
            }
        }

        async function generateQuotation() {
            const mileage = document.getElementById('mileage').value.trim();
            const version = document.getElementById('version').value.trim();

            if (!mileage || parseInt(mileage) < 0) {
                showError('Por favor ingresa un kilometraje v√°lido');
                return;
            }

            formData.mileage = mileage;
            formData.version = version; // Save version
            saveData();

            // Show loading
            document.querySelector(`.step[data-step="${currentStep}"]`).style.display = 'none';
            document.getElementById('loading').classList.add('active');

            try {
                // Get Gemini AI valuation
                const { make, model, year } = carData;
                const response = await fetch(`${API_BASE}/api/market-price?make=${encodeURIComponent(make)}&model=${encodeURIComponent(model)}&year=${encodeURIComponent(year)}&mileage=${encodeURIComponent(mileage)}`);
                const data = await response.json();

                // Hide loading
                document.getElementById('loading').classList.remove('active');

                if (!data.success) {
                    throw new Error(data.error || 'Error al obtener cotizaci√≥n');
                }

                formData.pricing = data.pricing; // Store pricing for submission

                const formatter = new Intl.NumberFormat('es-CL', {
                    style: 'currency',
                    currency: 'CLP',
                    minimumFractionDigits: 0
                });

                // Vehicle info
                document.getElementById('q-make').textContent = make || '-';
                document.getElementById('q-model').textContent = model || '-';
                document.getElementById('q-year').textContent = year || '-';
                document.getElementById('q-mileage').textContent = parseInt(mileage).toLocaleString('es-CL') + ' km';

                // Market Price + Range
                document.getElementById('marketPrice').textContent = formatter.format(data.pricing.market_price);
                if (data.market_data.min_price && data.market_data.max_price) {
                    document.getElementById('priceRange').textContent =
                        `Rango: ${formatter.format(data.market_data.min_price)} - ${formatter.format(data.market_data.max_price)}`;
                }

                // Immediate Purchase Offer
                document.getElementById('immediateOffer').textContent = formatter.format(data.pricing.immediate_offer);

                // Consignment Liquidation
                document.getElementById('consignmentPrice').textContent = formatter.format(data.pricing.consignment_liquidation);
                if (data.pricing.consignment_type === 'PERCENTAGE_BASED') {
                    document.getElementById('consignmentFee').textContent = 'Comisi√≥n: 5.355%';
                } else {
                    document.getElementById('consignmentFee').textContent = 'Fee fijo: $428.400';
                }

                // Market Analysis
                if (data.market_data.analysis) {
                    document.getElementById('marketAnalysis').style.display = 'block';
                    document.getElementById('analysisText').textContent = data.market_data.analysis;
                    const confidence = data.market_data.confidence || 0;
                    document.getElementById('confidenceBar').style.width = confidence + '%';
                    document.getElementById('confidenceText').textContent = confidence + '%';
                }

                // Source Links - Hidden per request (kept in formData for future use)
                const allSources = [...(data.sources || []), ...(data.listings || [])];
                formData.marketSources = allSources;
                saveData();

                document.getElementById('quotation').classList.add('active');
                updateProgress();

            } catch (error) {
                document.getElementById('loading').classList.remove('active');
                document.querySelector(`.step[data-step="${currentStep}"]`).style.display = 'block';
                showError('Error al generar la cotizaci√≥n: ' + error.message);
            }
        }

        async function sellWithUs() {
            const btn = document.querySelector('.whatsapp-btn');
            const originalText = btn.textContent;
            
            // Open window immediately to avoid popup blocker
            const whatsappWindow = window.open('', '_blank');
            if (whatsappWindow) {
                whatsappWindow.document.write('Cargando WhatsApp...');
            }

            btn.textContent = 'Enviando...';
            btn.disabled = true;

            try {
                // Submit lead data
                const response = await fetch(`${API_BASE}/api/submit-lead`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    // Create WhatsApp message
                    const message = `Hola! Me interesa vender mi ${carData.make} ${carData.model} ${carData.year}. 
Nombre: ${formData.firstName} ${formData.lastName}
Regi√≥n: ${formData.region}, ${formData.commune}
Patente: ${formData.plate}
Versi√≥n: ${formData.version || 'No especificada'}
Kilometraje: ${formData.mileage} km
Precio Mercado: $${formData.pricing.market_price}`;

                    const phone = '56968517995'; // Mr. Car Number
                    const url = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
                    
                    if (whatsappWindow) {
                        whatsappWindow.location.href = url;
                    } else {
                        // Fallback if window failed to open
                        window.location.href = url;
                    }
                    
                    alert('¬°Gracias! Hemos recibido tu solicitud. Te hemos enviado un correo con los detalles.');

                } else {
                    if (whatsappWindow) whatsappWindow.close();
                    alert('Hubo un error al enviar tu solicitud. Por favor intenta de nuevo.');
                }

            } catch (error) {
                console.error('Error submitting lead:', error);
                if (whatsappWindow) whatsappWindow.close();
                alert('Error de conexi√≥n. Intenta nuevamente.');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        updateProgress();
    </script>
</body>

</html>